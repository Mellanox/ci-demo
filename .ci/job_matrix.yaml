---
job: ci-demo

docker_host: harbor.mellanox.com
docker_path: /swx-storage/ci-demo
docker_auth: swx-storage
docker_opt: |
  -v /hpc/local:/hpc/local
  -v /auto/sw_tools:/auto/sw_tools
  -v /.autodirect/mtrswgwork:/.autodirect/mtrswgwork
  -v /.autodirect/sw/release/mlnx_ofed/MLNX_OFED:/.autodirect/sw/release/mlnx_ofed/MLNX_OFED

env:
  mofed_installer_exe: /.autodirect/sw/release/mlnx_ofed/MLNX_OFED/mlnx_ofed_install
  mofed_installer_opt: --user-space-only --without-fw-update --all -q

runs_on_dockers:
  - {name: 'centos7.7', tag: 'latest'}
  - {name: 'ubuntu16-4', tag: 'latest'}

matrix:
  axes:
    driver:
      - MLNX_OFED_LINUX-4.9-0.1.8.0
      - MLNX_OFED_LINUX-5.1-1.0.0.0
    cuda:
      - dev/cuda9.2
    arch:
      - x86_64

steps:

  - name: Prepare docker
    run: |
      echo Installing driver: ${driver} ...
      sudo env build=$driver $mofed_installer_exe $mofed_installer_opt

  - name: Build package
    run: .ci/build_package.sh

  - name: Coverity
    run: .ci/cov.sh

  - name: Check package
    run: .ci/check_package.sh

  - name: Run tests
    run: .ci/runtests.sh

    finalize:
      run: echo All done
